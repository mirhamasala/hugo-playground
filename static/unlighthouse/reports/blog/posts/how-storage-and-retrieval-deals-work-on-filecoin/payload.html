<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>How storage and retrieval deals work on Filecoin</title><meta name=author content="Filecoin"><meta property="og:title" content="How storage and retrieval deals work on Filecoin"><meta property="og:site_name" content="Filecoin"><meta property="og:url" content="https://filecoin.io/blog/posts/how-storage-and-retrieval-deals-work-on-filecoin/"><meta property="og:type" content="website"><meta name=twitter:card content="summary_large_image"><meta property="twitter:title" content="How storage and retrieval deals work on Filecoin"><meta name=description content="A short article on how storage and retrieval deals work in Filecoin."><meta property="og:description" content="A short article on how storage and retrieval deals work in Filecoin."><meta property="twitter:description" content="A short article on how storage and retrieval deals work in Filecoin."><meta property="og:image" content="https://filecoin.io/uploads/storage-deals-for-fil-news.png?c=1709069818"><meta name=twitter:image content="https://filecoin.io/uploads/storage-deals-for-fil-news.png?c=1709069818"><link rel=image_src href=https://filecoin.io/uploads/storage-deals-for-fil-news.png><link rel=canonical href=https://filecoin.io/blog/posts/how-storage-and-retrieval-deals-work-on-filecoin/><link rel=apple-touch-icon sizes=196x196 href=../../../images/favicons/favicon-196x196.png><link rel=icon type=image/png sizes=196x196 href=../../../images/favicons/favicon-196x196.png><link rel=icon type=image/png sizes=32x32 href=../../../images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../images/favicons/favicon-16x16.png><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https:\/\/filecoin.io\/#organization","@type":"Organization","name":"Filecoin","url":"https:\/\/filecoin.io\/","logo":{"@type":"ImageObject","url":"https:\/\/filecoin.io\/uploads\/filecoin-logo-symbol-only.png","width":800,"height":800},"description":"","sameAs":["https://www.facebook.com/Filecoin","https://twitter.com/Filecoin","https://www.linkedin.com/company/filecoin","https://github.com/filecoin-project"]},{"@id":"https:\/\/filecoin.io\/#website","@type":"WebSite","description":"","inLanguage":"en-US","name":"Filecoin","url":"https:\/\/filecoin.io\/"},{"@id":"https:\/\/filecoin.io\/blog\/posts\/how-storage-and-retrieval-deals-work-on-filecoin\/#webpage","@type":"WebPage","description":"","url":"https:\/\/filecoin.io\/blog\/posts\/how-storage-and-retrieval-deals-work-on-filecoin\/","isPartOf":{"@id":"https:\/\/filecoin.io\/#website"},"potentialAction":[{"@type":"ReadAction","target":["https:\/\/filecoin.io\/blog\/posts\/how-storage-and-retrieval-deals-work-on-filecoin\/"]}]}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How storage and retrieval deals work on Filecoin","description":"A short article on how storage and retrieval deals work in Filecoin.","image":"https:\/\/filecoin.io\/uploads\/fil-deals-lg.png","author":{"@type":"Person","name":""},"datePublished":"2021-03-09T17:00:00.000Z","articleSection":["updates"],"publisher":{"@type":"Organization","name":"Filecoin","logo":{"@type":"ImageObject","url":"https:\/\/filecoin.io\/uploads\/filecoin-logo-symbol-only.png","width":800,"height":800}},"mainEntityOfPage":"https:\/\/filecoin.io\/blog\/posts\/how-storage-and-retrieval-deals-work-on-filecoin\/"}</script><script defer data-domain=filecoin.io src=https://plausible.io/js/script.outbound-links.js></script>
<link rel=stylesheet href="https://filecoin.io/css/site.css?c=1709069818"></head><body class=body><div class="div alert-bar"><div class=alert-inner><span class=text><a href="https://fvm.filecoin.io/?utm_source=filecoin-website&utm_medium=referral&utm_campaign=fvm-launch&utm_content=en-us" target=_blank rel=noopener>Deploy smart contracts on Filecoin&rsquo;s Virtual Machine →</a></span>
<button class="button close" aria-label="close alert bar">
<img src=../../../images/svgs/x-off.svg></button></div></div><header class="nav-header header"><div class="div logo"><span data-slug=/><a class=anchor href=../../../><img class=image src=../../../images/filecoin-logo.svg alt=Filecoin></a></span></div><button class="button nav-handle" aria-label="toggle navigation"><div class="div hamburger hamburger--squeeze"><div class="div hamburger-box"><div class="div hamburger-inner"></div></div></div></button><div class="div navigation-container"><div class="div navigation"><div class="div grid"><nav class="main-nav Accordion"><ul class="list main-items"><li class=list-item data-slug=/store/><a class=anchor href=../../../store/>Store</a></li><li class=list-item><a class=anchor href="https://sp.filecoin.io/?utm_source=filecoin&utm_medium=referral&utm_campaign=sp-nav&utm_content=en-us" target=_blank rel=noreferrer>Provide</a></li><li class=list-item data-slug=/build/><a class=anchor href=../../../build/>Build</a>
<button class="button main-item" aria-label="accordion item"></button><div class="div submenu"><div class="div inner-dropdown"><div class="div triangle"></div><ul class="list sub-items"><li class="list-item sub-item"><button class=button data-anchor=benefits-banner aria-label="sub navigation">Docs</button></li><li class="list-item sub-item"><button class=button data-anchor=tools-and-more aria-label="sub navigation">Tools & services</button></li><li class="list-item sub-item"><button class=button data-anchor=grants aria-label="sub navigation">Grants</button></li><li class="list-item sub-item"><button class=button data-anchor=usp aria-label="sub navigation">Roadmap</button></li><li class="list-item sub-item"><button class=button data-anchor=videos aria-label="sub navigation">Videos</button></li><li class="list-item sub-item"><button class=button data-anchor=community aria-label="sub navigation">Filecoin Community</button></li><li class="list-item sub-item"><button class=button data-anchor=events aria-label="sub navigation">Events</button></li></ul></div></div></li><li class=list-item data-slug=/blog/><a class=anchor href=../../../blog/>Blog</a></li></ul></nav></div></div><div class="div sub-container"><nav class=sub><div class=community-nav><div class=selected><button class=button aria-label="change community-nav">
<span>Explore the Network</span></button></div><div class=dropdown><div class=inner-dropdown><ul class=list><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filfox.info/en>Filfox.info</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filscan.io/#/tipset/chain>Filscan.io</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filscout.io/en/>Filscout.io</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://spacegap.github.io>Spacegap</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filecoin.energy>Filecoin Green</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://dashboard.starboard.ventures>Starboard</a></li><li class=list-item><a class="list-note anchor">These explorers were built by community members and may have inaccuracies</a></li></ul></div></div></div></nav><div class=languages><div class=selected><span data-slug=en/><a class=anchor href=../../../en data-anchor=en/ class=active-lang>EN</a></span>
<span data-slug=zh-cn/><a class=anchor href=../../../zh-cn data-anchor=zh-cn/>中文</a></span></div></div></div></div><div class="div background"><div class="div light"></div><div class="div dark"></div><div class="div gray-light"></div><div class="div gray-dark"></div><div class="div blue"></div><div class="div transparent"></div></div></header><div class="div sections"><main class="main blog-single"><section class="section mode-light"><div class="div section-wrapper"><div class="div media-wrapper"><div class="div container"><div class="div media"><img class="image lazyload" data-sizes=auto data-srcset="../../../uploads/fil-deals-lg.png?width=667 667w,../../../uploads/fil-deals-lg.png?width=1333 1333w,../../../uploads/fil-deals-lg.png?width=2000 2000w" alt></div></div></div><div class="div grid"><div class="div metadata desktop grid"><div class="div categories"><div class="div label">Category:</div><ul class="list categories__items"><li class=list-item><a href=../../../blog/updates class=anchor>updates</a></li></ul></div><div class="div share"><ul class="list networks"><li class="list-item icon"><button class="button facebook" aria-label="facebook share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M19.841 17.925l.363-2.39h-2.27v-1.549c0-.653.317-1.29 1.334-1.29H20.3V10.66s-.937-.161-1.832-.161c-1.87.0-3.09 1.144-3.09 3.215v1.82H13.3v2.39h2.078V23.7a8.152 8.152.0 002.557.0v-5.775h1.906z" fill="#000"/></g></svg></button></li><li class="list-item icon"><button class="button twitter" aria-label="twitter share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M17.658 14.693l.029.454-.48-.055c-1.75-.213-3.278-.936-4.575-2.15l-.634-.603-.164.445c-.346.992-.125 2.039.596 2.743.384.39.298.445-.365.214-.23-.075-.433-.13-.452-.102-.067.064.164.908.346 1.242.25.463.76.917 1.317 1.186l.47.213-.557.01c-.538.0-.557.009-.5.203.193.603.952 1.242 1.798 1.52l.595.195-.519.296a5.603 5.603.0 01-2.575.686c-.432.01-.788.047-.788.075.0.092 1.172.611 1.855.815 2.047.603 4.478.343 6.304-.686 1.297-.732 2.595-2.187 3.2-3.596.327-.75.653-2.122.653-2.78.0-.427.03-.482.567-.992.318-.297.616-.621.673-.714.096-.176.087-.176-.403-.018-.817.278-.933.24-.529-.176.298-.297.653-.835.653-.992.0-.028-.144.018-.307.102a5.513 5.513.0 01-.846.315l-.519.157-.47-.305c-.26-.167-.625-.353-.817-.408-.49-.13-1.24-.111-1.682.037-1.201.417-1.96 1.492-1.874 2.67z" fill="#000"/></g></svg></button></li><li class="list-item icon"><button class="button linkedin" aria-label="linkedin share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M14.601 14.143V21.7h-2.55v-7.557h2.55zm.168-2.338c0 .726-.553 1.306-1.443 1.306h-.016c-.856.0-1.41-.58-1.41-1.306.0-.74.57-1.305 1.443-1.305s1.41.564 1.426 1.305zm9.031 5.562V21.7h-2.55v-4.043c0-1.016-.37-1.709-1.293-1.709-.705.0-1.124.468-1.309.919-.067.161-.084.387-.084.613v4.22h-2.55s.033-6.848.0-7.557h2.55v1.07c.339-.514.945-1.248 2.3-1.248 1.678.0 2.936 1.08 2.936 3.402z" fill="#000"/></g></svg></button></li></ul><div class="div fold-out icon"><a href=# class=anchor><img src=../../../images/icons/social/share.svg alt="Filecoin IPFS social media icon"></a></div></div></div><div class="div blog-content"><span class="author-date type-mono">Mar 9, 2021</span><br><h1 class="h title">How storage and retrieval deals work on Filecoin</h1><p>This blog post explains how Filecoin deals work from the perspective of both the storage providers (also known as miners) and the clients who want to store data on the Filecoin network.</p><p>The technical explanations in this post use the JSON-RPC API to interact with the Filecoin network when querying for data. This API is mostly used by applications. As a human, you can use the user friendly <code>lotus</code> command line tool, which uses the JSON-RPC API under the hood.</p><h2 id=introduction>Introduction</h2><p>The Filecoin network achieves economies of scale by allowing anyone to participate as a storage provider. Currently the network is made up of <a href=https://spacegap.github.io/ target=_blank rel=noopener>hundreds of storage providers</a> spread across the globe. Content addressing and cryptographic storage proofs verify that data is being stored correctly and securely over time on miners’ hardware, which creates a robust and reliable service.</p><p>This blog post covers the basic stages of the two types of deals in Filecoin, namely <em>storage deals</em> and <em>retrieval deals</em>, and details their lifecycle. The cryptographic proofs used to verify that participants in the system are performing their responsibilities according to their commitments are also explained.</p><h2 id=data-on-filecoin>Data on Filecoin</h2><p>In order to store files on Filecoin, clients must first import them in their local Filecoin node. This step produces a <em>data CID</em> - a content identifier, an ID that uniquely describes the content. Later, the data is transferred to a miner. Another way to store files on Filecoin is via <em>offline deals</em>, which is not cover in this post.</p><p>Importing data locally to a Filecoin node can be done with the <code>lotus client import</code> command. It&rsquo;s important to remember the resulting <em>data CID</em> (it is also available on the local node later on), because it must be used to later retrieve data from miners.</p><p>After importing data into the local node, users have to initiate a deal. This can be done with the <code>lotus client deal</code> command. The command takes a <em>data CID</em> as input, produces a <em>Filecoin Piece</em>, and interactively takes the user through the storage deal flow detailed below.</p><p>The <em>Filecoin Piece</em> is the main unit of negotiation for data that users store on the Filecoin network. The <em>Filecoin Piece</em> is not of a specific size, but is upper-bounded by the size of the <em>Sector</em>, governed by the <a href=https://network.filecoin.io/#mainnet target=_blank rel=noopener>parameters of the network</a>. If a <em>Filecoin Piece</em> is larger than the size of a <em>Sector</em> that the miner supports, it has to be split into more pieces so that each piece fits into a sector.</p><p><img src=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/vintage/images/blog/filecoin-deals/filecoin-piece.png alt="Filecoin Piece"></p><p>A <em>Filecoin Piece</em> is a <em>CAR</em> file containing an <em>IPLD DAG</em> with its own <em>data/payload CID</em> and <em>piece CID</em>.</p><p><em>CAR</em> stands for <a href=https://github.com/ipld/specs/blob/master/block-layer/content-addressable-archives.md target=_blank rel=noopener><em>Content Addressable aRchives</em></a> - a <em>CAR</em> file is a serialised representation of any <em>IPLD DAG</em> as the concatenation of its blocks, plus a header describing the graph in the file (with the <em>root CID</em>).</p><p>When a client wants to store a file in the Filecoin network, they start by producing the <em>IPLD DAG</em> of the file with <a href=https://github.com/ipfs/specs/blob/master/UNIXFS.md target=_blank rel=noopener>UnixFS</a> (this is what the <code>lotus client import</code> command does). The hash that represents the root node of the DAG is an IPFS-style <a href=https://github.com/multiformats/cid target=_blank rel=noopener>CID</a>, called data/<em>payload CID</em>.</p><p><a href=https://github.com/ipfs/specs/blob/master/UNIXFS.md target=_blank rel=noopener>UnixFS</a> is a protobuf-based format for describing files, directories, and symlinks in IPFS. UnixFS is used in Filecoin as a file formatting guideline for files submitted to the Filecoin network.</p><p>The resulting <em>CAR</em> file is padded with extra zero bits in order for the file to make a binary merkle tree.</p><h2 id=the-storage-deal-flow>The Storage Deal Flow</h2><p>Users can store data in and retrieve data from the Filecoin network via deals. Participants in the network, miners (supply-side) and clients (demand-side), interact with each other via <em>storage deals</em> and <em>retrieval deals</em>.</p><p>The lifecycle of a storage deal is as follows:</p><h3 id=1-discovery>1. <strong>Discovery</strong></h3><p>The client identifies miners and determines their current asks, i.e. the price per GiB per epoch (30sec.) in attoFIL (1 attoFIL is equal to 10^-18 * FIL) that miners want to receive in order to accept a deal. Currently a deal in Filecoin has a minimum duration of 180 days.</p><p>You can list all currently active miners by querying the JSON RPC API of a synced node (for test purposes the <a href=https://api.node.glif.io title=https://api.node.glif.io target=_blank rel=noopener><em>https://api.node.glif.io</em></a> public endpoint is used), with the <em>Filecoin.StateListMiners</em> method:</p><pre><code>curl -X POST -H &quot;Content-Type: application/json&quot; \
  --data '{ &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.StateListMiners&quot;, &quot;params&quot;: [ null ], &quot;id&quot;: 1 }' \
  'https://api.node.glif.io' | jq

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: [
    &quot;f011303&quot;,
    &quot;f011092&quot;,
    ...
</code></pre><p>You might want to decide on a specific provider based on their reputation or power in the network. Reputation metrics for miners are not part of the Filecoin protocol yet, and not covered in this post.</p><p>Once you have chosen a specific miner, you need to fetch its <em>PeerID</em>, for example with the <em>Filecoin.StateMinerInfo</em> method, to establish a secure connection to them via libp2p protocol:</p><pre><code>curl -X POST -H &quot;Content-Type: application/json&quot; \
  --data '{ &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.StateMinerInfo&quot;, &quot;params&quot;: [ &quot;f03274&quot;, null ], &quot;id&quot;: 1 }' \
  'https://api.node.glif.io' | jq

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;Owner&quot;: &quot;f03261&quot;,
    &quot;PeerId&quot;: &quot;12D3KooWP5D9TmqC45i6L2e2qQHYcuxaUwPdYo6CzqUMVmFEH3N9&quot;,
    ...
</code></pre><p>You can then query for a signed <em>StorageAsk</em> with the <em>Filecoin.ClientQueryAsk</em> method. This will establish a direct libp2p connection to the selected miner, and ask for a storage quote:</p><pre><code>curl -X POST https://api.node.glif.io \
     -H &quot;Content-Type: application/json&quot; --data-binary @- &lt;&lt; EOF
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.ClientQueryAsk&quot;, &quot;id&quot;: 1,
  &quot;params&quot;: [
    &quot;12D3KooWP5D9TmqC45i6L2e2qQHYcuxaUwPdYo6CzqUMVmFEH3N9&quot;,
    &quot;f03274&quot;
  ]
}
EOF

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;Price&quot;: &quot;100000000000&quot;,
    &quot;VerifiedPrice&quot;: &quot;100000000000&quot;,
    &quot;MinPieceSize&quot;: 256,
    &quot;MaxPieceSize&quot;: 34359738368,
    &quot;Miner&quot;: &quot;f03274&quot;,
    &quot;Timestamp&quot;: 148031,
    &quot;Expiry&quot;: 1199231,
    &quot;SeqNo&quot;: 14
  },
  &quot;id&quot;: 1
}
</code></pre><p>The result includes details about deals that this miner is willing to accept, such as range for the admitted <em>Filecoin Piece</em> sizes and price per GiB per epoch. Note that making a storage deal proposal which matches the miner’s storage ask is a precondition, but not sufficient to ensure the deal is accepted - the storage provider may run its own decision logic later on.</p><h3 id=2-negotiation-and-data-transfer>2. <strong>Negotiation and data transfer</strong></h3><p>During this phase both parties come to an agreement about the terms of the deal, such as the cost of deal, the duration of deal, the starting epoch of the deal, etc.</p><p>Then data is transferred from the client to the miner.</p><h3 id=3-publishing>3. <strong>Publishing</strong></h3><p>The deal is published on-chain, via the <code>PublishStorageDeals</code> message, making the storage provider publicly accountable for the deal.</p><h3 id=4-handoff>4. <strong>Handoff</strong></h3><p>Once the deal is published on-chain, it is handed over to the <em>Storage Mining subsystem</em>, to pack into a sector which is later <em>sealed</em>, and subsequently proven continuously.</p><h2 id=the-storage-mining-subsystem>The Storage Mining subsystem</h2><p>The Storage Mining subsystem ensures miners can effectively commit storage to the Filecoin network and:</p><ol><li>Participate in the <em>Filecoin Storage Market</em> by taking on client data and participating in storage deals.</li><li>Participate in <em>Filecoin Storage Power Consensus</em>, verifying and generating blocks to grow the Filecoin blockchain and earning block rewards and fees for doing so.</li></ol><p>It oversees the following processes:</p><h4 id=committing-new-storage-and-registering-new-sectors>Committing new storage and registering new sectors</h4><p>In order to register a sector in Filecoin, a miner must <em>seal</em> the sector. <em>Sealing</em> is a computation-heavy process that produces a unique representation of the data in the form of a proof, called <a href=https://spec.filecoin.io/#section-glossary.proof-of-replication-porep target=_blank rel=noopener>Proof-of-Replication</a> or <em>PoRep</em>. Once the proof has been generated, the miner compresses it and submits the result to the blockchain. This is a certification that the miner has indeed replicated a copy of the data they agreed to store.</p><h4 id=continuously-proving-storage-see-windowpost>Continuously proving storage (see WindowPoSt)</h4><p>Every storage miner must continuously submit proofs on-chain to prove that they continue to store their sectors.</p><h4 id=declaring-storage-faults-and-recovering-from-them-see-faults>Declaring storage faults and recovering from them (see Faults)</h4><p>Failing to submit the proofs mentioned above for a given sector will result in a fault, and the miner will be subject to penalties.</p><h2 id=storage-miner-and-client-considerations>Storage miner and client considerations</h2><p>As covered above, <em>storage deals</em> are published on-chain before they are active and sealed. This is important because publishing a deal locks clients’ funds in escrow on-chain. Thus, the miner has assurance that if they do indeed seal the data in a sector, they will get paid for it.</p><p>It helps to think of publishing a deal on-chain as signing a contract, and of sealing and activating a deal as starting to do the work the miner committed to.</p><p>From the perspective of a client who wants to store data on Filecoin, the deal passes roughly through the following stages:</p><ol><li><strong>Fund a deal</strong> - client locks funds in escrow</li><li><strong>Propose a deal</strong> to the miner</li><li><strong>Check for intent</strong> to accept deal</li><li><strong>Transfer data</strong> for the deal to the miner - this is done via the <a href=https://github.com/ipld/specs/blob/master/block-layer/graphsync/graphsync.md target=_blank rel=noopener>GraphSync</a> protocol. GraphSync is a protocol for synchronising IPLD graphs among peers. It allows a host to make a single request to a remote peer for all of the results of traversing an IPLD selector on the remote peer’s local IPLD graph. Lotus uses the <a href=https://github.com/ipfs/go-graphsync target=_blank rel=noopener>ipfs/go-graphsync</a> implementation of the GraphSync protocol.</li><li><strong>Check for acceptance</strong> - make sure that the miner has accepted the deal and published it on-chain.</li><li><strong>Sealing</strong> - deal is on-chain, and miner is currently sealing a sector that contains the deal.</li><li><strong>Active</strong> - deal has been sealed and is active. From here on, the storage provider/miner should periodically prove that they continue to store the data. More details in the Proof-of-Spacetime section below.</li></ol><p>From the perspective of a miner who provides a service to the client by storing their data, the deal passes roughly through the following stages:</p><ol><li><strong>Verify a deal</strong> - receive a proposal for a deal, and check it parameters (size, price, etc.)</li><li><strong>Check for locked funds</strong> - make sure that client has locked funds and can pay for the deal.</li><li><strong>Wait for data</strong> - receive data from client for the deal.</li><li><strong>Pledge collateral</strong> for the deal on chain</li><li><strong>Publish the deal</strong> on-chain</li><li><strong>Seal the sector</strong></li><li><strong>Activate deal</strong> - from here on, the storage provider/miner periodically submits WindowPoSt proofs, proving that they are continuously storing the data.</li></ol><h2 id=the-retrieval-deal-flow>The Retrieval Deal Flow</h2><p>Retrieval deals, unlike storage deals, happen mostly off-chain facilitated by payment channels. Data transmission is metered, and the client pays the miner incrementally as the data is being transferred. Creating payment channels, and redeeming vouchers, is the only part of the process which involves interacting with the Filecoin blockchain.</p><p>This is the overall process:</p><ol><li><strong>Discovery</strong> - the client identifies miners who have the data that it needs and requests a retrieval quote from them - price per byte, unseal price, payment interval.</li><li><strong>Payment channel setup</strong> - the client sets up a payment channel between them and the miner (if one doesn’t already exist).</li><li><strong>Data transfer with payment</strong> - miner sends data to client until payment is required. Payment processing is requested when a certain threshold is reached, and data transfer continues after that. Depending on whether the miner has the data in their <em>block-store</em> or not, they might need to first <em>unseal</em> it - a non-trivial and non-instantaneous operation, which is the opposite of <em>sealing</em> described in the section about storage deals.</li></ol><p>The client has not successfully retrieved a full copy of the data.</p><h2 id=proof-of-spacetime>Proof-of-Spacetime</h2><p>The sections above glanced over many details that make Filecoin unique and provide probabilistic guarantees on data to users. This section covers two of the proofs that Filecoin utilises, and also explains how they fit into the protocol and the problems they address.</p><p>Proof-of-Spacetime (PoSt) is a procedure by which a storage miner can prove to the Filecoin network they continue to store a unique copy of some data on behalf of the network.</p><p>Proof-of-Spacetime manifests in two distinct varieties in Filecoin today:</p><ol><li>Window Proof-of-Spacetime (WindowPoSt) and</li><li>Winning Proof-of-Spacetime (WinningPoSt)</li></ol><h2 id=winning-proof-of-spacetime>Winning Proof-of-Spacetime</h2><p>Winning Proof-of-Spacetime (WinningPoSt) is the mechanism by which storage miners are rewarded for their contributions to the Filecoin network. At the beginning of each epoch, a small number of storage miners are elected to each mine a new block. As a requirement for doing so, each miner is tasked with submitting a compressed Proof-of-Storage for a specified sector. Each elected miner who successfully creates a block is granted FIL (a block reward), as well as the opportunity to charge other Filecoin participants fees to include messages in the block.</p><p>Storage miners who fail to do this in the necessary window will forfeit their opportunity to mine a block, but will not otherwise incur penalties for their failure to do so.</p><h2 id=window-proof-of-spacetime>Window Proof-of-Spacetime</h2><p>Window Proof-of-Spacetime (WindowPoSt) is the mechanism by which the commitments made by storage miners are audited by the Filecoin blockchain.</p><p>Every storage miner should maintain their <em>pledged sectors</em>. These sectors contain deals made with clients or empty sectors. The latter are called <em>committed capacity</em>, that is, miners can make capacity commitments, filling a sector with arbitrary data, rather than with client data. Maintaining these sectors allows the storage miner to provably demonstrate that they are reserving space on behalf of the network.</p><p>Every day is broken down into an array of <em>windows</em>, currently 48 windows, with a duration of 30 minutes (60 epochs, since 1 epoch is equal to 30sec)</p><p>Each storage miner’s set of pledged sectors is partitioned into subsets, one subset for each window.</p><p>Within a given window (30min), each storage miner must submit a Proof-of-Spacetime for each sector in their respective subset. This requires ready access to each of the challenged sectors, and will result in a zk-SNARK proof published to the Filecoin blockchain as a message in a block. In this way, every sector of pledged storage is audited at least once in any 24-hour period, and a permanent, verifiable, and public record attesting to each storage miner’s continued commitment is kept.</p><p><img src=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/vintage/images/blog/filecoin-deals/deadlines.png alt="WindowPoSt sample deadlines"></p><p>In the diagram above, you can see that a sample miner should submit WindowPoSt proofs in <em>deadlines 0</em> (> 16TB), <em>deadline 1</em> (&lt; 8TB) and <em>deadline 2</em> (&lt; 8TB), with the majority of their sectors falling in <em>deadline 0</em>. Deadlines for each miner are randomised, and for this specific miner, start respectively in <em>epoch 1635</em>, in <em>epoch 1695</em>, and in <em>epoch 1755</em>. You can inspect these deadlines and more details about miners on the <a href=https://spacegap.github.io/#/miners/f02620 target=_blank rel=noopener>SpaceGap</a> tool.</p><p>The Filecoin network expects constant availability of stored data. Failing to submit WindowPoSt for a sector will result in a <em>fault</em>, and the storage miner supplying the sector will be <em>slashed</em>. This incentives storage miners for healthy behaviour.</p><h2 id=faults>Faults</h2><p>A fault occurs when a proof is not included in the Filecoin blockchain within the proving period, as a result of loss of network connectivity, storage malfunction, or malicious behaviour.</p><p>When a fault is registered for a sector, the Filecoin network will slash the storage miner that is supposed to be storing the sector; that is, it will assess penalties to the miner (to be paid out of the collateral fronted by the miner) for their failure to uphold their pledge of storage.</p><p>There are three types of sector fault fees:</p><ol><li><strong>Sector fault fee</strong> - This fee is paid per sector per day while the sector is in a faulty state. The size of the fee is slightly more than the amount the sector is expected to earn per day in block rewards. If a sector remains faulty for more than 2 consecutive weeks, the sector will pay a <strong>termination fee</strong> and be removed from the chain state.</li><li><strong>Sector fault detection fee</strong> - This is a one-time fee paid in the event of a failure if the miner does not report it honestly and instead the unreported failure is caught by the blockchain. Given the probabilistic nature of PoSt checks, this is set to a few days worth of block reward that would be expected to be earned by a particular sector.</li><li><strong>Sector termination fee</strong> - A sector can be terminated before its expiration date through automatic faults or miner decisions. A termination fee is charged that is, in principle, equivalent to how much a sector has earned so far, up to a limit in order to avoid discouraging long sector lifetimes.</li></ol><p>Read more about faults and economics around them at the <a href=https://spec.filecoin.io/ target=_blank rel=noopener>Filecoin Spec website</a></p><h2 id=conclusion>Conclusion</h2><p>This post covered some of the concepts related to storing and retrieving data on Filecoin, the protocols that clients and miners engage in to make that happen, and the different proofs and guarantees involved in the process.</p><p>It detailed the flow for storage and retrieval deals from the perspective of clients and miners, as well as the penalties that the Filecoin protocol would enforce in case one of the parties misbehaves.</p><p>To conclude, it outlined some of the foundations of how the Filecoin protocol governs the Filecoin network resulting in a reliable and trustless decentralised storage network.</p></div></div></div></section></main></div><section class="section hero3d mode-transparent-dark"><div class="div webgl"></div><img class=globe-still alt="Filecoin is an open-source cloud storage marketplace, protocol, and incentive layer." data-src alt><div class="div sprites2d"><div class="div icon-client"><img class=image data-src=../../../images/svgs/icon_client.svg alt=icon_client></div><div class="div icon-request pin"><img class=image data-src=../../../images/svgs/filecoin_request_icon.svg alt=filecoin_request_icon><div class="div vertical-line"></div></div><div class="div icon-doc pin"><img class=image data-src=../../../images/svgs/filecoin_data_icon.svg alt=filecoin_data_icon><div class="div vertical-line"></div></div><div class="div icon-doc-black"><img class=image data-src=../../../images/svgs/filecoin_data_icon_black.svg alt=filecoin_data_icon_black></div><div class="div icon-miner"><img class=image data-src=../../../images/svgs/icon_miner.svg alt=icon_miner></div><div class="div icon-miner-orange"><img class=image data-src=../../../images/svgs/icon_miner_other.svg alt=icon_miner_other></div><div class="div icon-package pin"><img class=image data-src=../../../images/svgs/filecoin_data_icon_black.svg alt=filecoin_data_icon_black><div class="div vertical-line"></div></div><div class="div icon-coin-spin spritesheet" data-src=../../../images/coin_sprite.png data-spritesheet-width=50 data-spritesheet-height=50 data-spritesheet-frames=17></div><div class="div icon-question-in spritesheet" data-src=../../../images/proof_sprites1.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=14></div><div class="div icon-question-to-check spritesheet" data-src=../../../images/proof_sprites2.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=16></div><div class="div icon-check-to-block spritesheet" data-src=../../../images/proof_sprites3.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=43></div><div class="div icon-block-out spritesheet" data-src=../../../images/proof_sprites4.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=14></div><div class="div icon-block-approved spritesheet" data-src=../../../images/block_approved.png data-spritesheet-width=75 data-spritesheet-height=75 data-spritesheet-frames=69></div><div class="div icon-block-declined spritesheet" data-src=../../../images/block_declined.png data-spritesheet-width=75 data-spritesheet-height=75 data-spritesheet-frames=69></div><div class="div text-field"><span class=text></span></div></div><div class="div fade-plane"></div></section><div class="div click-blocker"></div><footer class="footer mode-dark"><div class="div grid"><div class="div tagline"><span class=type-unit>Filecoin is an open-source cloud storage marketplace, protocol, and incentive layer.</span></div><div class="div col-contact"><h5 class="h h5 type-base">Reach out</h5><ul class=list><li class=list-item><a class=anchor href=https://filecoin.io/slack target=_blank rel=noreferrer>Slack</a></li><li class=list-item><a class=anchor href=https://weixin.qq.com/r/1xz54Y-EctINrcuC90nF target=_blank rel=noreferrer>WeChat
<img class="image lazyload" data-sizes=auto data-srcset="../../../uploads/wechat-qr.jpg?width=67 67w,../../../uploads/wechat-qr.jpg?width=133 133w,../../../uploads/wechat-qr.jpg?width=200 200w" alt></a></li><li class=list-item><a class=anchor href=https://twitter.com/Filecoin target=_blank rel=noreferrer>Twitter</a></li><li class=list-item><a class=anchor href=https://github.com/filecoin-project/community#forums target=_blank rel=noreferrer>Forum</a></li><li class=list-item><a class=anchor href=https://t.me/filecoin target=_blank rel=noreferrer>Telegram</a></li></ul></div><div class="div col-resources"><h5 class="h h5 type-base">Resources</h5><ul class=list><li class=list-item><a class=anchor href=https://filecoin.io/blog/ target=_blank rel=noreferrer>Blog</a></li><li class=list-item><a class=anchor href=https://docs.filecoin.io/ target=_blank rel=noreferrer>Docs</a></li><li class=list-item><a class=anchor href=https://github.com/filecoin-project target=_blank rel=noreferrer>GitHub</a></li><li class=list-item><a class=anchor href=https://proto.school/course/filecoin target=_blank rel=noreferrer>ProtoSchool</a></li><li class=list-item><a class=anchor href=https://security.filecoin.io/ target=_blank rel=noreferrer>Security</a></li></ul></div><div class="div col-newsletter"><h5 class="h h5 type-base">Sign up for Filecoin updates</h5><div class="div newsletter-container" id=newsletter><form class=form novalidate><div class="div input-container"><label class=label for=newsletter-email>Your email</label>
<input class="input email" id=newsletter-email type=text placeholder="Your email" required>
<label class=label for=newsletter-submit>Submit</label>
<input class=input id=newsletter-submit type=submit>
<span class=success-icon></span></div><div class="div error-message"><p class=p>Something went wrong. Please try again.</p></div><div class="div success-message"><p class=p>You’ve been signed up for our newsletter. Thank you!</p></div></form></div></div></div></footer><script src="https://filecoin.io/js/vendor.bundle.js?c=1709069818"></script>
<script src="https://filecoin.io/js/bundle.js?c=1709069818"></script></body></html>