<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>了解Filecoin 中的存储和检索交易</title><meta name=author content="Filecoin"><meta property="og:title" content="了解Filecoin 中的存储和检索交易"><meta property="og:site_name" content="Filecoin"><meta property="og:url" content="https://filecoin.io/zh-cn/blog/posts/filecoin-storage-and-retrieval-deals/"><meta property="og:type" content="website"><meta name=twitter:card content="summary_large_image"><meta property="twitter:title" content="了解Filecoin 中的存储和检索交易"><meta name=description content="本文阐明 Filecoin 中的存储交易和检索交易如何运作。"><meta property="og:description" content="本文阐明 Filecoin 中的存储交易和检索交易如何运作。"><meta property="twitter:description" content="本文阐明 Filecoin 中的存储交易和检索交易如何运作。"><meta property="og:image" content="https://filecoin.io/uploads/storage-retrievaldeals.png?c=1706629545"><meta name=twitter:image content="https://filecoin.io/uploads/storage-retrievaldeals.png?c=1706629545"><link rel=image_src href=https://filecoin.io/uploads/storage-retrievaldeals.png><link rel=canonical href=https://filecoin.io/zh-cn/blog/posts/filecoin-storage-and-retrieval-deals/><link rel=apple-touch-icon sizes=196x196 href=../../../../images/favicons/favicon-196x196.png><link rel=icon type=image/png sizes=196x196 href=../../../../images/favicons/favicon-196x196.png><link rel=icon type=image/png sizes=32x32 href=../../../../images/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../../../images/favicons/favicon-16x16.png><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@id":"https:\/\/filecoin.io\/#organization","@type":"Organization","name":"Filecoin","url":"https:\/\/filecoin.io\/","logo":{"@type":"ImageObject","url":"https:\/\/filecoin.io\/uploads\/filecoin-logo-symbol-only.png","width":800,"height":800},"description":"","sameAs":["https://www.facebook.com/Filecoin","https://twitter.com/Filecoin","https://www.linkedin.com/company/filecoin","https://github.com/filecoin-project"]},{"@id":"https:\/\/filecoin.io\/#website","@type":"WebSite","description":"","inLanguage":"en-US","name":"Filecoin","url":"https:\/\/filecoin.io\/"},{"@id":"https:\/\/filecoin.io\/zh-cn\/blog\/posts\/filecoin-storage-and-retrieval-deals\/#webpage","@type":"WebPage","description":"","url":"https:\/\/filecoin.io\/zh-cn\/blog\/posts\/filecoin-storage-and-retrieval-deals\/","isPartOf":{"@id":"https:\/\/filecoin.io\/#website"},"potentialAction":[{"@type":"ReadAction","target":["https:\/\/filecoin.io\/zh-cn\/blog\/posts\/filecoin-storage-and-retrieval-deals\/"]}]}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"了解Filecoin 中的存储和检索交易","description":"本文阐明 Filecoin 中的存储交易和检索交易如何运作。","image":"https:\/\/filecoin.io\/uploads\/storage-retrievaldeals.png","author":{"@type":"Person","name":""},"datePublished":"2021-03-09T17:00:00.000Z","articleSection":["updates"],"publisher":{"@type":"Organization","name":"Filecoin","logo":{"@type":"ImageObject","url":"https:\/\/filecoin.io\/uploads\/filecoin-logo-symbol-only.png","width":800,"height":800}},"mainEntityOfPage":"https:\/\/filecoin.io\/zh-cn\/blog\/posts\/filecoin-storage-and-retrieval-deals\/"}</script><script defer data-domain=filecoin.io src=https://plausible.io/js/script.outbound-links.js></script>
<link rel=stylesheet href="https://filecoin.io/css/site.css?c=1706629545"></head><body class=body><div class="div alert-bar"><div class=alert-inner><span class=text><a href="https://fvm.filecoin.io/?utm_source=filecoin-website&utm_medium=referral&utm_campaign=fvm-launch&utm_content=zh-cn" target=_blank rel=noopener>3月14日起开始在Filecoin 虚拟机上部署智能合约吧→</a></span>
<button class="button close" aria-label="close alert bar">
<img src=../../../../images/svgs/x-off.svg></button></div></div><header class="nav-header header"><div class="div logo"><span data-slug=/><a class=anchor href=../../../../zh-cn><img class=image src=../../../../images/filecoin-logo.svg alt=Filecoin></a></span></div><button class="button nav-handle" aria-label="toggle navigation"><div class="div hamburger hamburger--squeeze"><div class="div hamburger-box"><div class="div hamburger-inner"></div></div></div></button><div class="div navigation-container"><div class="div navigation"><div class="div grid"><nav class="main-nav Accordion"><ul class="list main-items"><li class=list-item data-slug=/zh-cn/store/><a class=anchor href=../../../../zh-cn/store/>存储</a></li><li class=list-item><a class=anchor href="https://sp.filecoin.io/?utm_source=filecoin&utm_medium=referral&utm_campaign=sp-nav&utm_content=zh-cn" target=_blank rel=noreferrer>提供</a></li><li class=list-item data-slug=/zh-cn/build/><a class=anchor href=../../../../zh-cn/build/>开发</a>
<button class="button main-item" aria-label="accordion item"></button><div class="div submenu"><div class="div inner-dropdown"><div class="div triangle"></div><ul class="list sub-items"><li class="list-item sub-item"><button class=button data-anchor=benefits-banner aria-label="sub navigation">文档</button></li><li class="list-item sub-item"><button class=button data-anchor=tools-and-more aria-label="sub navigation">工具与服务</button></li><li class="list-item sub-item"><button class=button data-anchor=grants aria-label="sub navigation">开发者津贴</button></li><li class="list-item sub-item"><button class=button data-anchor=usp aria-label="sub navigation">路线图</button></li><li class="list-item sub-item"><button class=button data-anchor=videos aria-label="sub navigation">视频</button></li><li class="list-item sub-item"><button class=button data-anchor=community aria-label="sub navigation">Filecoin社区</button></li><li class="list-item sub-item"><button class=button data-anchor=events aria-label="sub navigation">活动</button></li></ul></div></div></li><li class=list-item data-slug=/zh-cn/blog/><a class=anchor href=../../../../zh-cn/blog/>博客</a></li></ul></nav></div></div><div class="div sub-container"><nav class=sub><div class=community-nav><div class=selected><button class=button aria-label="change community-nav">
<span>探索网络</span></button></div><div class=dropdown><div class=inner-dropdown><ul class=list><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filfox.info/zh>Filfox.info</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filscan.io/#/tipset/chain>Filscan.io</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filscout.io/zh/>Filscout.io</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://spacegap.github.io>Spacegap</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://dashboard.starboard.ventures>Starboard</a></li><li class=list-item><a class=anchor target=_blank rel=noreferrer href=https://filecoin.energy>Filecoin Green</a></li><li class=list-item><a class="list-note anchor">以上浏览器为社区成员所打造并可能有所出入</a></li></ul></div></div></div></nav><div class=languages><div class=selected><span data-slug=en/><a class=anchor href=../../../../en data-anchor=en/>EN</a></span>
<span data-slug=zh-cn/><a class=anchor href=../../../../zh-cn data-anchor=zh-cn/ class=active-lang>中文</a></span></div></div></div></div><div class="div background"><div class="div light"></div><div class="div dark"></div><div class="div gray-light"></div><div class="div gray-dark"></div><div class="div blue"></div><div class="div transparent"></div></div></header><div class="div sections"><main class="main blog-single"><section class="section mode-light"><div class="div section-wrapper"><div class="div media-wrapper"><div class="div container"><div class="div media"><img class="image lazyload" data-sizes=auto data-srcset="../../../../uploads/storage-retrievaldeals.png?width=667 667w,../../../../uploads/storage-retrievaldeals.png?width=1333 1333w,../../../../uploads/storage-retrievaldeals.png?width=2000 2000w" alt></div></div></div><div class="div grid"><div class="div metadata desktop grid"><div class="div categories"><div class="div label">Category:</div><ul class="list categories__items"><li class=list-item><a href=../../../blog/updates class=anchor>updates</a></li></ul></div><div class="div share"><ul class="list networks"><li class="list-item icon"><button class="button facebook" aria-label="facebook share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M19.841 17.925l.363-2.39h-2.27v-1.549c0-.653.317-1.29 1.334-1.29H20.3V10.66s-.937-.161-1.832-.161c-1.87.0-3.09 1.144-3.09 3.215v1.82H13.3v2.39h2.078V23.7a8.152 8.152.0 002.557.0v-5.775h1.906z" fill="#000"/></g></svg></button></li><li class="list-item icon"><button class="button twitter" aria-label="twitter share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M17.658 14.693l.029.454-.48-.055c-1.75-.213-3.278-.936-4.575-2.15l-.634-.603-.164.445c-.346.992-.125 2.039.596 2.743.384.39.298.445-.365.214-.23-.075-.433-.13-.452-.102-.067.064.164.908.346 1.242.25.463.76.917 1.317 1.186l.47.213-.557.01c-.538.0-.557.009-.5.203.193.603.952 1.242 1.798 1.52l.595.195-.519.296a5.603 5.603.0 01-2.575.686c-.432.01-.788.047-.788.075.0.092 1.172.611 1.855.815 2.047.603 4.478.343 6.304-.686 1.297-.732 2.595-2.187 3.2-3.596.327-.75.653-2.122.653-2.78.0-.427.03-.482.567-.992.318-.297.616-.621.673-.714.096-.176.087-.176-.403-.018-.817.278-.933.24-.529-.176.298-.297.653-.835.653-.992.0-.028-.144.018-.307.102a5.513 5.513.0 01-.846.315l-.519.157-.47-.305c-.26-.167-.625-.353-.817-.408-.49-.13-1.24-.111-1.682.037-1.201.417-1.96 1.492-1.874 2.67z" fill="#000"/></g></svg></button></li><li class="list-item icon"><button class="button linkedin" aria-label="linkedin share"><svg viewBox="0 0 35 35" xmlns="http://www.w3.org/2000/svg"><g fill-rule="nonzero" fill="none"><circle class="circle" stroke="#f0f0f0" stroke-width="2" cx="17.5" cy="17.5" r="16.5"/><path d="M14.601 14.143V21.7h-2.55v-7.557h2.55zm.168-2.338c0 .726-.553 1.306-1.443 1.306h-.016c-.856.0-1.41-.58-1.41-1.306.0-.74.57-1.305 1.443-1.305s1.41.564 1.426 1.305zm9.031 5.562V21.7h-2.55v-4.043c0-1.016-.37-1.709-1.293-1.709-.705.0-1.124.468-1.309.919-.067.161-.084.387-.084.613v4.22h-2.55s.033-6.848.0-7.557h2.55v1.07c.339-.514.945-1.248 2.3-1.248 1.678.0 2.936 1.08 2.936 3.402z" fill="#000"/></g></svg></button></li></ul><div class="div fold-out icon"><a href=# class=anchor><img src=../../../../images/icons/social/share.svg alt="Filecoin IPFS social media icon"></a></div></div></div><div class="div blog-content"><span class="author-date type-mono">Mar 9, 2021</span><br><h1 class="h title">了解Filecoin 中的存储和检索交易</h1><p>本文从存储提供方（也就是矿工）和使用 Filecoin 网络存储数据的用户的视角，解释 Filecoin 交易的运作原理。</p><p>本文的技术性解析部分，使用 JSON-RPC 的 API 格式来与 Filecoin 网络交互，查询数据。该 API 主要由应用程序使用。人工操作时，您可以使用更友好的 <code>lotus</code> 命令行工具。其底层也是使用 JSON-RPC API 的。</p><h2 id=介绍>介绍</h2><p>通过允许任何人作为存储提供者参与，Filecoin网络实现规模经济。目前，该网络由分布在全球各地的<a href=https://spacegap.github.io/ target=_blank rel=noopener>数百个存储提供者</a>组成。内容寻址和加密存储证明验证了数据在矿工的硬件上长期正确安全地存储，从而创造了一个强大可靠的服务。</p><p>本文阐述了Filecoin中两种交易类型，<em>存储交易</em> 和 <em>检索交易</em> 运作的各个阶段，并详解其生命周期。并解释了密码学证明是如何用于验证系统中的参与者是否按照承诺履行职责的。</p><h2 id=filecoin-上的数据>Filecoin 上的数据</h2><p>为在Filecoin上存储文件，用户必须首先在其本地Filecoin节点中导入文件。这一步会产生一个 <em>数据CID</em> ——即内容标识符，描述该内容的唯一ID。之后，数据被传给矿工。另一种在Filecoin上存储文件的方式是通过 <em>离线交易</em>，不在本文讨论范围中。</p><p>将数据导入本地的Filecoin节点这步，可以通过<code>lotus client import</code>命令来完成。要记住所产生的 <em>数据CID</em>（之后在本地节点上也可获取），因为以后从矿工那里检索数据时会用到。</p><p>将数据导入本地节点后，用户需发起交易。这步通过<code>lotus client deal</code>命令来完成。该命令将一个 <em>数据CID</em> 作为输入，产生一个 <em>Filecoin Piece</em> ，并交互式引导用户完成存储交易流程，详见下文。</p><p><em>Filecoin Piece</em> 是用户在Filecoin网络上存储数据的主要协商单位。<em>Filecoin Piece</em> 并没有特定的大小，而是以 <em>扇区</em> 大小为上限，受<a href=https://network.filecoin.io/#mainnet target=_blank rel=noopener>网络参数</a>控制。如果一个 <em>Filecoin Piece</em> 大于矿工支持的 <em>扇区</em> 的大小，它必须被分割成更多的碎片，以便每个碎片都适合一个扇区。</p><p><img src=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/vintage/images/blog/filecoin-deals/filecoin-piece.png alt="Filecoin Piece"></p><p>每个 <em>Filecoin Piece</em> 是一个 <em>CAR</em> 文件，包含一个 <em>IPLD DAG</em>，有对应的 <em>数据 CID</em> 和 <em>piece CID</em>。</p><p><em>CAR</em> 即 <a href=https://github.com/ipld/specs/blob/master/block-layer/content-addressable-archives.md target=_blank rel=noopener><em>内容可寻址档案（Content Addressable aRchives）</em></a> - 每个 <em>CAR</em> 文件是一个 <em>IPLD DAG</em> 的序列化表示，即将其数据块串起来，再加上描述DAG图的头部信息（还有 <em>根CID</em> ）。</p><p>当用户要在Filecoin网络中存储文件时，首先要用<a href=https://github.com/ipfs/specs/blob/master/UNIXFS.md target=_blank rel=noopener>UnixFS</a>制作文件的 <em>IPLD DAG</em> (这就是<code>lotus client import</code>命令的作用)。代表DAG根节点的哈希是一个IPFS风格的<a href=https://github.com/multiformats/cid target=_blank rel=noopener>CID</a>，称为 <em>数据 CID</em> 。</p><p><a href=https://github.com/ipfs/specs/blob/master/UNIXFS.md target=_blank rel=noopener>UnixFS</a>是一种基于protobuf的格式，用于描述IPFS中的文件、目录和软链接。在Filecoin中，UnixFS是文件格式标准，文件以此格式提交给Filecoin网络。</p><p>所产生的 <em>CAR</em> 文件用额外的零位来补齐，以便使文件写为二叉merkle树。</p><h2 id=存储交易流程>存储交易流程</h2><p>用户在 Filecoin 网络中通过交易存取数据。网络的参与者，包括矿工（供给方）和用户（需求方），通过 <em>存储交易</em> 和 <em>检索交易</em> 来与对方交互。</p><p>存储交易的生命周期如下：</p><h3 id=1-发现>1. <strong>发现</strong></h3><p>用户先确定矿工及其定价，即矿工为了接受交易而希望收到的每epoch（30秒）每GiB的价格，单位为attoFIL（1 attoFIL等于10^-18 * FIL）。目前，Filecoin中一笔交易的最短期限为180天。</p><p>您可以通过 JSON RPC API 查询已同步的节点，列出所有当前活跃的矿工（为了测试目的，使用了<a href=https://api.node.glif.io title=https://api.node.glif.io target=_blank rel=noopener>https://api.node.glif.io_</a>公共终端节点），使用 <em>Filecoin.StateListMiners</em> 方法。</p><pre><code>curl -X POST -H &quot;Content-Type: application/json&quot; \
  --data '{ &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.StateListMiners&quot;, &quot;params&quot;: [ null ], &quot;id&quot;: 1 }' \
  'https://api.node.glif.io' | jq

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: [
    &quot;f011303&quot;,
    &quot;f011092&quot;,
    ...
</code></pre><p>您可以根据矿工在网络中的信誉和能力进行选择。矿工的信誉指标还未进入 Filecoin 协议，本文亦不涉及。</p><p>当您选好矿工之后，可以用诸如 <em>Filecoin.StateMinerInfo</em> 方法来获取矿工的 <em>PeerID</em> ，用于在 libp2p 协议中来与对方建立安全连接。</p><pre><code>curl -X POST -H &quot;Content-Type: application/json&quot; \
  --data '{ &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.StateMinerInfo&quot;, &quot;params&quot;: [ &quot;f03274&quot;, null ], &quot;id&quot;: 1 }' \
  'https://api.node.glif.io' | jq

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;Owner&quot;: &quot;f03261&quot;,
    &quot;PeerId&quot;: &quot;12D3KooWP5D9TmqC45i6L2e2qQHYcuxaUwPdYo6CzqUMVmFEH3N9&quot;,
    ...
</code></pre><p>接下来，您可以用 <em>Filecoin.ClientQueryAsk</em> 方法获取一个带签名的 <em>StorageAsk</em> 。这将与选定的矿工建立 libp2p 连接，并询问存储报价。</p><pre><code>curl -X POST https://api.node.glif.io \
     -H &quot;Content-Type: application/json&quot; --data-binary @- &lt;&lt; EOF
{
  &quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;Filecoin.ClientQueryAsk&quot;, &quot;id&quot;: 1,
  &quot;params&quot;: [
    &quot;12D3KooWP5D9TmqC45i6L2e2qQHYcuxaUwPdYo6CzqUMVmFEH3N9&quot;,
    &quot;f03274&quot;
  ]
}
EOF

{
  &quot;jsonrpc&quot;: &quot;2.0&quot;,
  &quot;result&quot;: {
    &quot;Price&quot;: &quot;100000000000&quot;,
    &quot;VerifiedPrice&quot;: &quot;100000000000&quot;,
    &quot;MinPieceSize&quot;: 256,
    &quot;MaxPieceSize&quot;: 34359738368,
    &quot;Miner&quot;: &quot;f03274&quot;,
    &quot;Timestamp&quot;: 148031,
    &quot;Expiry&quot;: 1199231,
    &quot;SeqNo&quot;: 14
  },
  &quot;id&quot;: 1
}
</code></pre><p>结果包括该矿工愿意接受的交易细节，如接纳的 <em>Filecoin Piece</em> 大小的范围和每GiB每epoch的价格。需要注意的是，提出与矿工的存储要求相匹配的存储交易，只是一个前提条件，但并不足以确保交易被接受 - 存储提供者可能会在之后运行自己的决策逻辑。</p><h3 id=2-议价和数据发送>2. <strong>议价和数据发送</strong></h3><p>在这一阶段，双方就交易条款达成协议，如交易成本、交易期限、交易起始时间等。</p><p>然后，数据从用户发至矿工。</p><h3 id=3-发布>3. <strong>发布</strong></h3><p>通过 <code>PublishStorageDeals</code> 消息在链上发布交易，使存储提供方对交易公开负责。</p><h3 id=4-完成>4. <strong>完成</strong></h3><p>交易一旦在链上发布，就会被交给 <em>挖矿子系统</em> ，打包成扇区，随后 <em>封装</em> ，再不断地被证明可用。</p><h2 id=存储挖矿子系统>存储挖矿子系统</h2><p>存储挖矿子系统确保 Filecoin 网络的数据由矿工有效保存，并且：</p><ol><li>参与 <em>Filecoin 存储市场</em> ，承接用户数据，参与存储交易。</li><li>参与 <em>Filecoin 存储算力共识</em> ，验证和产出区块，让 Filecoin 区块链增长，并获得区块奖励。</li></ol><p>该系统监督以下进程：</p><h4 id=承诺新存储和注册新扇区>承诺新存储和注册新扇区</h4><p>为了在Filecoin中注册一个扇区，矿工必须对该扇区进行 <em>封装</em> 。_封装_过程需要大量计算，以证明的形式产生数据的唯一表示，即<a href=https://spec.filecoin.io/#section-glossary.proof-of-replication-porep target=_blank rel=noopener>复制证明</a>或 <em>PoRep</em> 。一旦证明生成，矿工会对其进行压缩，并将结果提交给区块链。这就证明矿工确实复制了他们同意存储的数据副本。</p><h4 id=证明存储持续可用-见windowpost>证明存储持续可用 (见WindowPoSt)</h4><p>所有存储矿工需要持续提交链上证明，以验证扇区被完整存储。</p><h4 id=宣布存储故障和从故障中恢复见故障>宣布存储故障和从故障中恢复（见故障）</h4><p>如果扇区所需的上述证明如果未成功提交，将导致故障，矿工会受到处罚。</p><h2 id=存储矿工和用户的考量>存储矿工和用户的考量</h2><p>如上文所述，<em>存储交易</em> 是在链上发布后，才会被激活和封装。这一点很重要，因为发布交易会将用户的资金锁定在链上托管。只有如此，在封存数据进扇区之后，矿工的收益才有保障。</p><p>可以将在链上发布交易视为签署合同，将封装和激活交易视为开始做承诺的工作。</p><p>从用户的角度来看，想要用 Filecoin 存储数据，交易大致经过以下几个阶段：</p><ol><li><strong>交易入金</strong> - 用户将资金锁入代管中</li><li><strong>向矿工提出</strong> 交易提议</li><li><strong>检查意向</strong>来接受交易</li><li><strong>数据传输</strong>给矿工来进行交易 - 这是通过<a href=https://github.com/ipld/specs/blob/master/block-layer/graphsync/graphsync.md target=_blank rel=noopener>GraphSync</a>协议完成的。GraphSync是节点之间同步IPLD图的协议。该协议允许本地节点向远程节点发出请求，以获取在远程节点的IPLD图上按选择器搜索所得的结果。Lotus使用的是GraphSync协议的实现<a href=https://github.com/ipfs/go-graphsync target=_blank rel=noopener>ipfs/go-graphsync</a>。</li><li><strong>检查是否接受</strong> - 确保矿工已经接受了交易并在链上发布。</li><li><strong>封装</strong> - 交易已在链上，矿工正在封装包含交易的扇区。</li><li><strong>激活</strong> - 交易已被封存并处于活跃状态。从这里开始，存储提供商/矿工应定期证明他们继续存储数据。详见下面的<a href=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/blog/filecoin-how-deals-work/#proof-of-spacetime target=_blank rel=noopener>时空证明</a>。</li></ol><p>从矿工的角度来看，通过存储用户的数据来提供服务，交易大致经过以下几个阶段：</p><ol><li><strong>验证交易</strong> - 收到交易提议，并检查其参数（大小、价格等）。</li><li><strong>检查是否有锁定资金</strong> - 确保用户有锁定资金，可以支付交易。</li><li><strong>等待数据</strong> - 接收客户提供的交易数据。</li><li><strong>为交易提供抵押</strong> 用于链上交易。</li><li><strong>在链上发布交易</strong> 上链。</li><li><strong>封装扇区</strong></li><li><strong>激活交易</strong> - 从这里开始，存储提供者（矿工）定期提交<a href=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/blog/filecoin-how-deals-work/#window-post target=_blank rel=noopener>WindowPoSt</a>，证明他们在持续存储数据。</li></ol><h2 id=检索交易流程>检索交易流程</h2><p>检索交易与存储交易不同，使用支付通道，主要链下完成。数据传输是按量计价的，用户在数据传输的过程中逐步向矿工支付费用。整个过程中，只有创建支付通道、兑换凭证，是涉及与 Filecoin 区块链交互的。</p><p>整体流程如下：</p><ol><li><strong>发现</strong> - 用户找出拥有其所需数据的矿工，并向其索取检索报价详情 - 每字节价格、解封价格、付款间隔。</li><li><strong>设立支付通道</strong> - 用户需要和矿工之间设立一个支付通道（如果还不存在的话）。</li><li><strong>数据传输与支付</strong> - 矿工向用户发送数据，直到需要支付。当达到一定的阈值时，会要求进行支付处理，之后继续进行数据传输。根据矿工是否在他们的 <em>区块存储</em> 中拥有数据，他们可能需要首先 <em>解封</em> 数据 - 这是一个非常规和非瞬时的操作，这是存储交易一节中描述的 <em>封装</em> 的反向操作。</li></ol><p>此时用户还未获取完整数据。</p><h2 id=时空证明>时空证明</h2><p>上面的章节快速列举了许多使 Filecoin 独一无二的细节，在概率上对用户数据提供了保证。本节介绍了 Filecoin 使用的两种证明，并解释了它们是如何成为协议的一部分，以及它们所解决的问题。</p><p>时空证明（PoSt）是矿工向 Filecoin 网络提交的证明，证明其正在继续为网络存储数据的唯一副本。</p><p>目前，时空证明在 Filecoin 中以两种类型存在：</p><ol><li>WindowPoSt</li><li>WinningPoSt</li></ol><h2 id=winningpost>WinningPoSt</h2><p>WinningPoSt是奖励存储矿工对 Filecoin 网络贡献的机制。在每个epoch开始时，一小部分存储矿工被选出来，每个矿工挖出一个新的区块。具体要求是，这些矿工提交指定扇区的压缩存储证明。每个成功创建区块的当选矿工都会获得FIL（区块奖励），以及向其他想在区块中包含信息的 Filecoin 参与者收取费用的机会。</p><p>存储矿工如果在必要的时间窗口内没按要求做到，将失去生产区块的机会，但不会因为没产出区块而受到其他惩罚。</p><h2 id=windowpost>WindowPoSt</h2><p>WindowPoSt是 Filecoin 区块链对存储矿工做出的承诺进行审核的机制。</p><p>每个存储矿工都应该维护他们的_承诺扇区_。这些扇区包含与用户达成的交易，或也可能为空。后者被称为_承诺容量_，也就是说，矿工可以做出容量承诺，用任意数据填充一个扇区，而非用户数据。维护这些扇区可以让存储矿工证明他们在代网络预留空间。</p><p>每一天分成若干 <em>时间窗口</em> ，目前48个时间窗口，每个持续时间为30分钟（60个epoch，因为1个epoch等于30秒）。</p><p>每个矿工的承诺扇区分成若干组，每组对应一个时间窗口。</p><p>在一个时间窗（30分钟）内，每个存储矿工必须为其该时间窗中的每个扇区提交一份时空证明。这需要随时访问该时间窗轮到的每个扇区，并生成 zk-SNARK 证明加入区块发布到 Filecoin 区块链上。这样，每个承诺存储的扇区在每24小时内至少会被审核一次，并保留一个永久的、可验证的、公开的记录，证明每个存储矿工保守承诺。</p><p><img src=https://bafybeifviznbhfp5ap3pph4qvwlamyits5jptozp6tpgfj2agrprsi45yq.on.fleek.co/vintage/images/blog/filecoin-deals/deadlines.png alt="时间窗口 deadline 举例"></p><p>在上图例子中，您能看到一个矿工应该在 <em>deadline 0(> 16TB)、deadline 1(&lt; 8TB) 和 deadline 2</em> (&lt; 8TB) 提交窗口时空证明，其中大部分扇区都在 <em>deadline 0</em> 。每个矿工的 deadline 是随机的，对于这个特定的矿工来说，分别从 <em>epoch 1635、epoch 1695和epoch 1755</em> 开始。你可以在<a href=https://spacegap.github.io/#/miners/f02620 target=_blank rel=noopener>SpaceGap</a>工具上检查这些 deadline 和更多关于矿工的细节。</p><p>Filecoin 网络期望所存储的数据持续可用。未能为一个扇区提交WindowPoSt将导致一个 <em>故障</em> ，而供应该扇区的存储矿工将被 <em>惩罚</em> 。这激励存储矿工健康运转。</p><h2 id=故障>故障</h2><p>当因为网络连接丢失、存储故障或恶意行为导致证明未在期限内被纳入Filecoin区块链时，故障就发生了。</p><p>当一个扇区被登记为故障时，Filecoin 网络将对本应存储该扇区的存储矿工进行惩罚；也就是说，将对矿工未能持续存储的行为进行处罚评估（从矿工预付的抵押品中支付）。</p><p>扇区故障费分为三类：</p><ol><li><strong>扇区故障费</strong> - 需由每个处于故障状态的扇区每天支付。该费用的大小略高于该扇区每天预计获得的区块奖励额。如果一个扇区连续2周以上处于故障状态，该扇区将支付<strong>终止费</strong>，并从区块链状态中移除。</li><li><strong>扇区故障检测费</strong> - 这是一次性支付的费用，如果该故障是由链上机制检测发现而非矿工诚实上报时收取。考虑到时空证明检查的概率性，该收费额设为对应扇区在若干天时间中的区块奖励。</li><li><strong>扇区终止费</strong> - 一个扇区可能因为故障或矿工主动而在到期日之前终止。收取的终止费原则上相当于一个扇区当前所产生的收益，且不超过一个限额，以免阻碍长时扇区。</li></ol><p>您可在 <a href=https://spec.filecoin.io/ target=_blank rel=noopener>Filecoin 规范</a> 阅读更多关于故障和处理故障的经济机制。</p><h2 id=结论>结论</h2><p>本文描述了关于存储和检索 Filecoin 上数据的一些概念、用户和矿工为存取数据使用的协议以及这些流程中所涉的各类证明和保证。</p><p>从用户和矿工的视角，详细介绍存储交易和检索交易的流程；以及在某一方出现恶意行为时， Filecoin 协议对其的惩罚措施。</p><p>总结起来，本文概述了 Filecoin 协议如何管理 Filecoin 网络，使之成为一个可靠和无信任的去中心化存储网络。</p></div></div></div></section></main></div><section class="section hero3d mode-transparent-dark"><div class="div webgl"></div><img class=globe-still alt=Filecoin是一个开源的云存储市场、协议和加密货币 data-src alt><div class="div sprites2d"><div class="div icon-client"><img class=image data-src=../../../../images/svgs/icon_client.svg alt=icon_client></div><div class="div icon-request pin"><img class=image data-src=../../../../images/svgs/filecoin_request_icon.svg alt=filecoin_request_icon><div class="div vertical-line"></div></div><div class="div icon-doc pin"><img class=image data-src=../../../../images/svgs/filecoin_data_icon.svg alt=filecoin_data_icon><div class="div vertical-line"></div></div><div class="div icon-doc-black"><img class=image data-src=../../../../images/svgs/filecoin_data_icon_black.svg alt=filecoin_data_icon_black></div><div class="div icon-miner"><img class=image data-src=../../../../images/svgs/icon_miner.svg alt=icon_miner></div><div class="div icon-miner-orange"><img class=image data-src=../../../../images/svgs/icon_miner_other.svg alt=icon_miner_other></div><div class="div icon-package pin"><img class=image data-src=../../../../images/svgs/filecoin_data_icon_black.svg alt=filecoin_data_icon_black><div class="div vertical-line"></div></div><div class="div icon-coin-spin spritesheet" data-src=../../../../images/coin_sprite.png data-spritesheet-width=50 data-spritesheet-height=50 data-spritesheet-frames=17></div><div class="div icon-question-in spritesheet" data-src=../../../../images/proof_sprites1.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=14></div><div class="div icon-question-to-check spritesheet" data-src=../../../../images/proof_sprites2.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=16></div><div class="div icon-check-to-block spritesheet" data-src=../../../../images/proof_sprites3.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=43></div><div class="div icon-block-out spritesheet" data-src=../../../../images/proof_sprites4.png data-spritesheet-width=65 data-spritesheet-height=65 data-spritesheet-frames=14></div><div class="div icon-block-approved spritesheet" data-src=../../../../images/block_approved.png data-spritesheet-width=75 data-spritesheet-height=75 data-spritesheet-frames=69></div><div class="div icon-block-declined spritesheet" data-src=../../../../images/block_declined.png data-spritesheet-width=75 data-spritesheet-height=75 data-spritesheet-frames=69></div><div class="div text-field"><span class=text></span></div></div><div class="div fade-plane"></div></section><div class="div click-blocker"></div><footer class="footer mode-dark"><div class="div grid"><div class="div tagline"><span class=type-unit>Filecoin是一个开源的云存储市场、协议和加密货币</span></div><div class="div col-contact"><h5 class="h h5 type-base">联系我们</h5><ul class=list><li class=list-item><a class=anchor href=https://filecoin.io/slack target=_blank rel=noreferrer>Slack频道</a></li><li class=list-item><a class=anchor href=https://weixin.qq.com/r/1xz54Y-EctINrcuC90nF target=_blank rel=noreferrer>微信公众号</a></li><li class=list-item><a class=anchor href=https://twitter.com/Filecoin target=_blank rel=noreferrer>推特号</a></li><li class=list-item><a class=anchor href=https://github.com/filecoin-project/community-china/discussions target=_blank rel=noreferrer>社区讨论</a></li><li class=list-item><a class=anchor href=https://t.me/filecoin target=_blank rel=noreferrer>Telegram电报群</a></li></ul></div><div class="div col-resources"><h5 class="h h5 type-base">链接资源</h5><ul class=list><li class=list-item><a class=anchor href=https://filecoin.io/zh-cn/blog target=_blank rel=noreferrer>博客</a></li><li class=list-item><a class=anchor href=https://docs.filecoin.io/ target=_blank rel=noreferrer>Docs文档</a></li><li class=list-item><a class=anchor href=https://github.com/filecoin-project target=_blank rel=noreferrer>GitHub代码库</a></li><li class=list-item><a class=anchor href=https://proto.school/course/filecoin target=_blank rel=noreferrer>ProtoSchool课程</a></li><li class=list-item><a class=anchor href=https://security.filecoin.io/ target=_blank rel=noreferrer>Security安全</a></li></ul></div><div class="div col-newsletter"><h5 class="h h5 type-base">点击接受Filecoin基金会的新闻推送</h5><div class="div newsletter-container" id=newsletter><form class=form novalidate><div class="div input-container"><label class=label for=newsletter-email>您的邮箱</label>
<input class="input email" id=newsletter-email type=text placeholder=您的邮箱 required>
<label class=label for=newsletter-submit>Submit</label>
<input class=input id=newsletter-submit type=submit>
<span class=success-icon></span></div><div class="div error-message"><p class=p>出错了，请再试一次。</p></div><div class="div success-message"><p class=p>感谢您关注Filecoin新闻。谢谢！</p></div></form></div></div></div></footer><script src="https://filecoin.io/js/vendor.bundle.js?c=1706629545"></script>
<script src="https://filecoin.io/js/bundle.js?c=1706629545"></script></body></html>